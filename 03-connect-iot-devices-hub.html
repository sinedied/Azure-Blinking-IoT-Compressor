<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>3. Connection au cloud | Azure IoT workshop</title>
    <meta name="description" content="">
    <meta name="generator" content="VuePress 1.3.0">
    <link rel="icon" href="/iot-workshop/bit-iot.png">
  <meta name="theme-color" content="#0078d7">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black">
  <meta name="msapplication-TileColor" content="#0078d7">
    <meta property="og:image" content="https://sinedied.github.io/iot-workshop/bit-iot.png"><meta name="twitter:image" content="https://sinedied.github.io/iot-workshop/bit-iot.png"><meta property="og:url" content="https://sinedied.github.io/iot-workshop/03-connect-iot-devices-hub.html"><meta name="twitter:url" content="https://sinedied.github.io/iot-workshop/03-connect-iot-devices-hub.html"><meta property="og:title" content="3. Connection au cloud"><meta name="twitter:title" content="3. Connection au cloud"><meta itemprop="name" content="3. Connection au cloud"><meta property="og:type" content="website"><meta name="twitter:card" content="summary"><meta property="og:site_name" content="Azure IoT Workshop"><meta name="twitter:site" content="@chmaneu"><meta name="twitter:creator" content="@chmaneu">
    <link rel="preload" href="/iot-workshop/assets/css/0.styles.694f9356.css" as="style"><link rel="preload" href="/iot-workshop/assets/js/app.8c4c5b71.js" as="script"><link rel="preload" href="/iot-workshop/assets/js/2.7913e008.js" as="script"><link rel="preload" href="/iot-workshop/assets/js/4.4f288e13.js" as="script"><link rel="prefetch" href="/iot-workshop/assets/js/10.c111af0d.js"><link rel="prefetch" href="/iot-workshop/assets/js/11.d79f0cb7.js"><link rel="prefetch" href="/iot-workshop/assets/js/12.3f0b14c3.js"><link rel="prefetch" href="/iot-workshop/assets/js/13.67a9e161.js"><link rel="prefetch" href="/iot-workshop/assets/js/14.3e43ca60.js"><link rel="prefetch" href="/iot-workshop/assets/js/15.1b268ab3.js"><link rel="prefetch" href="/iot-workshop/assets/js/3.091fb9b7.js"><link rel="prefetch" href="/iot-workshop/assets/js/5.0b37f156.js"><link rel="prefetch" href="/iot-workshop/assets/js/6.70392e21.js"><link rel="prefetch" href="/iot-workshop/assets/js/7.667c89ef.js"><link rel="prefetch" href="/iot-workshop/assets/js/8.6cd0e39e.js"><link rel="prefetch" href="/iot-workshop/assets/js/9.16f58e21.js">
    <link rel="stylesheet" href="/iot-workshop/assets/css/0.styles.694f9356.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/iot-workshop/" class="home-link router-link-active"><img src="/iot-workshop/bit-iot.png" alt="Azure IoT workshop" class="logo"> <span class="site-name can-hide">Azure IoT workshop</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="https://github.com/sinedied/iot-workshop" target="_blank" rel="noopener noreferrer" class="nav-link external">
  GitHub
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="https://github.com/sinedied/iot-workshop" target="_blank" rel="noopener noreferrer" class="nav-link external">
  GitHub
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <!----></nav>  <ul class="sidebar-links"><li><a href="/iot-workshop/" class="sidebar-link">Introduction</a></li><li><a href="/iot-workshop/01-prepare-environment.html" class="sidebar-link">1. Pr√©paration</a></li><li><a href="/iot-workshop/02-azure-function-detect-activity.html" class="sidebar-link">2. D√©tection d'activit√©</a></li><li><a href="/iot-workshop/03-connect-iot-devices-hub.html" class="active sidebar-link">3. Connection au cloud</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/iot-workshop/03-connect-iot-devices-hub.html#creer-un-iot-hub" class="sidebar-link">Cr√©er un IoT Hub</a></li><li class="sidebar-sub-header"><a href="/iot-workshop/03-connect-iot-devices-hub.html#connecter-votre-carte-iot-a-iot-hub-üîå" class="sidebar-link">Connecter votre carte IoT √† IoT Hub üîå</a></li><li class="sidebar-sub-header"><a href="/iot-workshop/03-connect-iot-devices-hub.html#traiter-les-evenement-du-hub-avec-azure-functions" class="sidebar-link">Traiter les √©v√©nement du Hub avec Azure Functions</a></li></ul></li><li><a href="/iot-workshop/04-simulate-devices.html" class="sidebar-link">(Bonus) Et sans mat√©riel?</a></li><li><a href="/iot-workshop/whats-next.html" class="sidebar-link">Et apr√®s ?</a></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="connectez-votre-board-a-votre-iot-hub"><a href="#connectez-votre-board-a-votre-iot-hub" class="header-anchor">#</a> Connectez votre board √† votre IoT Hub</h1> <p>Jusqu'√† pr√©sent, vous avez travaill√© sur une solution IoT qui a d√©j√† √©t√© cr√©√©e pour
vous √† l'avance. Dans ce module, nous allons voir comment cr√©er une solution IoT
compl√®te √† l'aide d'<a href="https://docs.microsoft.com/azure/iot-hub/about-iot-hub?WT.mc_id=msroadshowwinter-event-yolasors" target="_blank" rel="noopener noreferrer">Azure IoT Hub<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>.
Ce service vous permet de cr√©er de solutions IoT pouvant g√©rer des millions de devices, tout en vous permettant d'abstraire la complexit√© de communication avec
les devices IoT (Internet public, r√©seaux sigfox ou LoRA, etc...), ainsi que la
diversit√© des types de devices (Rasperry Pi, Arduino, microcontr√¥leurs, PC, Mobiles, ...).</p> <p>Avant de poursuivre, pensez √† installer l'ensemble <a href="/iot-workshop/01-prepare-environment.html#module-connectez-vos-devices-iot-au-cloud">des pr√©requis</a> n√©cessaires √† cette partie. Ils seront n√©cessaires afin de reconfigurer votre board pour qu'elle communique avec l'IoT Hub que vous allez cr√©er.</p> <ul><li>Cr√©er les ressources dans Azure</li> <li>Reconfigurer votre board</li> <li>Connectez votre fonction √† votre IoT Hub</li> <li>Acc√©dez a vos devices depuis Visual Studio Code</li></ul> <h2 id="creer-un-iot-hub"><a href="#creer-un-iot-hub" class="header-anchor">#</a> Cr√©er un IoT Hub</h2> <p>L'IoT Hub est un service qui vous permet de g√©rer la connexion entre vos devices IoT et vos services h√©berg√©s sur Azure
(ou ailleurs). Plus concr√®tement, il vous permet :</p> <ul><li>D'identifier et de recevoir des donn√©es de vos p√©riph√©riques IoT - on appelle cela le <em>Device To Cloud</em>,</li> <li>D'envoyer ces donn√©es √† diff√©rents applicatifs,</li> <li>De transmettre des commandes ou des donn√©es du cloud vers vos p√©riph√©riques - c'est le <em>Cloud To Device</em>,</li> <li>De mettre √† jour les micrologiciels √† distance de vos p√©riph√©riques, voire de d√©ployer du code √† distance.</li></ul> <p>La vid√©o suivante nous montre comment cr√©er un nouveau IoT Hub. Choisissez bien le groupe de ressources cr√©√© √† l'√©tape
pr√©c√©dente, puis choisissez la r√©gion (Europe occidentale) puis un nom.</p> <blockquote><p>Comme beaucoup de ressources dans Azure, leur nom devient une partie d'une adresse Internet - ici
<code>monhub.chris-ioth.azure-devices.net</code>. Il doit donc √™tre unique √† tous les utilisateurs d'Azure !</p></blockquote> <p>A l'√©tape d'apr√®s, vous serez amen√© √† choisir un niveau de tarification (<em>tier</em>) et une mise √† l'√©chelle. Pour cet
atelier, nous choisirons la taille <strong>S1: Niveau Standard</strong>.</p> <blockquote><p>Il existe √† aujourd'hui trois tiers. Le tiers gratuit est limit√© en nombre de messages, alors que le tiers basique ne
dispose pas des fonctionnalit√©s <em>Cloud to Device</em> ou <em>Device Twins</em> que nous allons utiliser plus loin. Le nombre
d'unit√©s permet quand √† lui de supporter un plus grand nombre de p√©riph√©riques IoT.</p></blockquote> <p><img src="/iot-workshop/assets/img/creation-iothub.6016bbcb.gif" alt="Video - Cr√©ation d'un IoT Hub"></p> <p>Maintenant que votre hub est cr√©√©, il vous reste √† effectuer deux √©tapes :</p> <ul><li>Connecter votre carte √† l'IoT Hub que vous venez de cr√©er</li> <li>Traiter les messages re√ßus par votre IoT Hub</li></ul> <h2 id="connecter-votre-carte-iot-a-iot-hub-üîå"><a href="#connecter-votre-carte-iot-a-iot-hub-üîå" class="header-anchor">#</a> Connecter votre carte IoT √† IoT Hub üîå</h2> <h3 id="creer-un-device-dans-l-iot-hub"><a href="#creer-un-device-dans-l-iot-hub" class="header-anchor">#</a> Cr√©er un <em>device</em> dans l'IoT Hub</h3> <p>Au sein du IoT Hub, chacun de vos p√©riph√©riques IoT se doit d'√™tre d√©clar√© afin de pouvoir le g√©rer et accepter des
donn√©es. Pour cet atelier simple, nous allons ajouter le p√©riph√©rique √† la main. Si nous avions √† d√©ployer des millions
de p√©riph√©riques, il y a bien √©videmment <a href="https://docs.microsoft.com/azure/iot-dps/?WT.mc_id=msroadshowwinter-event-yolasors" target="_blank" rel="noopener noreferrer">une solution<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> üòÉ Et comme tout service Azure, il existe une
API Rest - et souvent un SDK - qui permet <a href="https://github.com/cmaneu/Azure-Blinking-IoT-Compressor/blob/master/src/functions-dispatcher/CreateDevice.cs" target="_blank" rel="noopener noreferrer">d'automatiser certaines t√¢ches<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>.</p> <p>La cr√©ation d'un device IoT dans le portail est assez simple. Naviguez jusqu'√† l'onglet <strong>Appareils IoT</strong> (IoT Devices), puis cliquez
sur <strong>Ajouter</strong>. Vous avez alors simplement √† donner un nom √† votre p√©riph√©rique. Pour notre workshop, il n'y a bas besoin de
configurer les autres options.</p> <p><img src="/iot-workshop/assets/img/creation-iotdevice.5d8f4ca0.gif" alt="Video - Cr√©ation d'un p√©riph√©rique IoT Hub"></p> <p>Lorsque vous vous rendez sur l'√©cran de votre appareil IoT - en cliquant sur son nom - , vous aurez acc√®s √† deux cl√©s ainsi que les cha√Ænes de connexion correspondantes. <strong>Ce sont elles qui permettent de s√©curiser la connexion entre votre appareil et Azure</strong>.</p> <div class="custom-block warning"><p class="custom-block-title">Attention</p> <p>Il est important <strong>de ne pas les diffuser ou les mettre dans votre code source (ou repository Github)</strong>. Nous verrons juste apr√®s comment la d√©ployer sur la carte.</p></div> <div class="custom-block tip"><p class="custom-block-title">Note</p> <p><strong>Pourquoi il y a-t-il deux cl√©s et non pas une ?</strong> C'est pour permettre la rotation de cl√©s, une bonne pratique en mati√®re de s√©curit√©.</p></div> <p><strong>Notez cette cl√© d'acc√®s quelque part</strong> ou gardez la fen√™tre ouverte, nous allons l'utiliser dans quelques instants.</p> <h3 id="configurer-la-chaine-de-connection-sur-votre-board"><a href="#configurer-la-chaine-de-connection-sur-votre-board" class="header-anchor">#</a> Configurer la cha√Æne de connection sur votre board</h3> <p>Il faut maintenant <em>donner</em> cette cl√© d'acc√®s √† la board. Il existe un emplacement m√©moire sp√©cifique permettant de contenir ce genre d'informations.</p> <div class="custom-block tip"><p class="custom-block-title">Note</p> <p>La board <em>MXChip</em> poss√®de une puce de s√©curit√©, permettant notamment de prot√©ger ce genre de secrets, y compris
si le firmware √©tait corrompu. Sa mise en oeuvre prendrait un peu de temps, et elle est irr√©versible. Les boards
que nous vous pr√™tons pour le workshop √©tant r√©utilis√©es, nous n'utiliserons pas cette fonctionnalit√©.</p></div> <p>Visual Studio Code a une fonctionnalit√© vous permettant tr√®s simplement d'uploader sur la board cette configuration.
Cependant, celle-ci n'est disponible que lorsque vous avez un projet <em>IoT Workbench</em>. Nous allons cr√©er un projet
&quot;vide&quot;. Ouvrez une nouvelle instance de Visual Studio Code, et effectuez les √©tapes suivantes:</p> <ul><li><strong>Azure IoT Device Workbench: Create Project...</strong></li> <li>Donner un nom</li> <li>Le type de board, s√©lectionner <strong>Arduino</strong></li> <li>Template de projet: choisir <strong>MXChip IoT DevKit with Azure IoT Hub</strong></li></ul> <p>Assurez-vous que Visual Studio a bien s√©lectionn√© votre type de board ainsi que le port s√©rie (√©mul√© via l'USB).
Vous pouvez voir en bas √† droite le port s√©lectionn√©. Sur l'image ci-dessous, aucun port n'est s√©lectionn√©.</p> <p><img src="/iot-workshop/assets/img/vscode-selectcom.92b0f364.png" alt=""></p> <p>Cliquez sur <code>&lt;Select Serial Port&gt;</code> et s√©lectionnez le port COM avec la l√©gende <em>ST Microelectronics</em>.</p> <p><img src="/iot-workshop/assets/img/vscode-selectcom-list.4d25aec3.png" alt=""></p> <p>Le port s√©lectionn√© s'affiche alors en bas √† droite.</p> <p><img src="/iot-workshop/assets/img/vscode-com.2fd3c707.jpg" alt="S√©lecteur Visual Studio Code de board et de port s√©rie"></p> <p>Vous pouvez d√©sormais uploader la cha√Æne de connexion sur la board. Pour se faire :</p> <ol><li>Maintenez appuy√© le bouton <strong>A</strong> puis appuyez et rel√¢chez le bouton <strong>reset</strong> pour passer en mode configuration</li> <li>A l'aide de la commande <code>Azure IoT Device Workbench: Configure Device Settings</code>, choisissez <code>Config Device Connection String</code>,
puis <code>Input IoT Hub Device Connection String</code>, et collez la connection string compl√®te g√©n√©r√©e au d√©but de l'atelier.</li></ol> <p>Une notification de confirmation va appara√Ætre dans Visual Studio Code. Vous pouvez maintenant red√©marrer votre board.</p> <h3 id="tester-la-connexion-entre-les-deux"><a href="#tester-la-connexion-entre-les-deux" class="header-anchor">#</a> Tester la connexion entre les deux</h3> <p>Une fois que votre board a red√©marr√©e - vous pouvez appuyer sur le bouton physique <strong>reset</strong> pour le forcer, vous pouvez voir sur l'√©cran de la board si les envois de messages sont r√©ussis. Le message <code>Update #99 sent</code>
appara√Æt alors (avec un num√©ro s√©quentiel √† la place de 99).</p> <p>Dans la prochaine √©tape, nous allons reconnecter votre Azure Function avec IoT Hub pour qu'elle
traite les messages.</p> <h2 id="traiter-les-evenement-du-hub-avec-azure-functions"><a href="#traiter-les-evenement-du-hub-avec-azure-functions" class="header-anchor">#</a> Traiter les √©v√©nement du Hub avec Azure Functions</h2> <p>Jusqu'√† pr√©sent, nous vous avions abstrait une partie de la complexit√© - et des services -
n√©cessaires pour r√©aliser l'architecture. Comme vous pouvez le voir sur le sch√©ma ci-dessous,
une Azure Function ne peut pas consommer directement des messages provenant de l'IoT Hub.</p> <p>Pour se faire, nous devons passer par un autre service, <strong>Azure Event Hubs</strong>. C'est un service
d'ingestion de donn√©es en temps r√©el, simple et hautement scalable (on peut parler facilement
de millions d'√©v√©nements par seconde). L'API est propri√©taire (avec des SDK opensources pour
de nombreux langages), mais il est √©galement possible de l'utiliser avec une API Kafka
(Event Hubs peut donc √™tre utilis√© comme un service Kafka enti√®rement manag√© !).</p> <p><img src="/iot-workshop/assets/img/schema-arch.95a0412e.png" alt=""></p> <h3 id="creer-un-event-hub"><a href="#creer-un-event-hub" class="header-anchor">#</a> Cr√©er un Event Hub</h3> <p>Pour utiliser un event hub, vous avez besoin de deux composants :</p> <ul><li>Un Namespace : C'est un conteneur pour un Event Hub (tel qu'un topic kafka).</li> <li>Un Event Hub : C'est l'unit√© de scaling/processing des messages.</li></ul> <p>Commencez par cr√©er un namespace, via le menu de cr√©ation de ressources. Vous pouvez choisir
le m√™me ressource group que pr√©c√©demment. Choisissez √©galement la m√™me r√©gion que celle de votre IoT Hub
et Azure Function.</p> <p><img src="/iot-workshop/assets/img/hub-connect-01.c7c5694b.png" alt=""></p> <p>Une fois cr√©√©, il vous faudra alors cr√©er l'Event Hub. Vous pouvez le faire via le bouton <strong>+ Event Hub</strong> sur
la ressource Namespace.</p> <p><img src="/iot-workshop/assets/img/hub-connect-02.e5728a98.png" alt=""> <img src="/iot-workshop/assets/img/hub-connect-03.517484a3.png" alt=""></p> <h3 id="configurer-l-envoi-des-messages-de-l-iot-hub-vers-l-event-hub"><a href="#configurer-l-envoi-des-messages-de-l-iot-hub-vers-l-event-hub" class="header-anchor">#</a> Configurer l'envoi des messages de l'IoT Hub vers l'Event Hub</h3> <p>Nous allons maintenant indiquer √† l'IoT Hub qu'il doit envoyer les donn√©es qu'il re√ßoit
vers l'Event Hub que nous avons cr√©√©. Pour cela, retournez sur votre ressource IoT Hub, et
cliquez sur <strong>Message routing</strong> dans le menu de gauche.</p> <p><img src="/iot-workshop/assets/img/hub-connect-04.4a1c2268.png" alt=""></p> <blockquote><p>L'exercice ici est tr√®s simple. Pour un d√©ploiement en production, il faudrait ajuster un certain nombre
de param√®tres en fonction du nombre de devices ainsi que du nombre de flux consommant les donn√©es
de l'IoT Hub - et notamment avoir le nombre de partitions en cons√©quence.</p></blockquote> <p>Vous pouvez alors ajouter une route. Il faudra choisir un nouveau endpoint de type Event Hubs.
Assurez-vous de router les messages de type <code>Device Telemetry Message</code>.</p> <p><img src="/iot-workshop/assets/img/hub-connect-05.9a476959.png" alt=""> <img src="/iot-workshop/assets/img/hub-connect-06.68ee67c6.png" alt=""></p> <p>A partir de maintenant, tous les messages re√ßus des devices par l'IoT Hub seront renvoy√©s
vers l'Event hubs.</p> <blockquote><p>Vous avez un peu de temps ? Cr√©ez un compte de stockage, et une route suppl√©mentaire afin
d'envoyer √©galement les messages sur un stockage √† froid pour une analyse √† post√©riori.</p></blockquote> <h3 id="developper-l-azure-function-pour-consommer-les-messages-de-l-event-hub"><a href="#developper-l-azure-function-pour-consommer-les-messages-de-l-event-hub" class="header-anchor">#</a> D√©velopper l'Azure Function pour consommer les messages de l'Event Hub</h3> <p>Il nous faut d√©sormais consommer les messages provanent de l'Event Hub. Le plus simple pour cela
est de cr√©er une nouvelle fonction - par exemple dans la m√™me app que celle cr√©√©e lors du module 2.</p> <p>Vous pouvez reprendre votre projet Azure Functions et refaire les √©tapes en s√©lectionnant le trigger
<code>Event Hubs</code>. Visual Studio Code vous proposera alors de s√©lectionner l'Event Hub que vous souhaitez
consommer.</p> <p><img src="/iot-workshop/assets/img/hub-connect-07.dea355a9.png" alt=""> <img src="/iot-workshop/assets/img/hub-connect-08.2ef3b62d.png" alt=""> <img src="/iot-workshop/assets/img/hub-connect-09.f53d4a25.png" alt=""> <img src="/iot-workshop/assets/img/hub-connect-10.4a6fc17c.png" alt=""> <img src="/iot-workshop/assets/img/hub-connect-11.337e2a89.png" alt=""> <img src="/iot-workshop/assets/img/hub-connect-12.c52b0d89.png" alt=""> <img src="/iot-workshop/assets/img/hub-connect-13.057bfdc0.png" alt=""></p> <p>Vous pouvez r√©utiliser le code cr√©√© lors du module 2, mais avec quelques adaptations üòÉ.
Tout d'abord, le message que vous allez recevoir a un format diff√©rent de celui re√ßu au module 2.
Voici un exemple de JSON que vous allez re√ßevoir :</p> <div class="language-json extra-class"><pre class="language-json"><code><span class="token punctuation">{</span>
    <span class="token property">&quot;Topic&quot;</span><span class="token operator">:</span> <span class="token string">&quot;iot&quot;</span><span class="token punctuation">,</span> 
    <span class="token property">&quot;t&quot;</span><span class="token operator">:</span> <span class="token number">25.5</span><span class="token punctuation">,</span>
    <span class="token property">&quot;p&quot;</span><span class="token operator">:</span> <span class="token number">1003.3</span><span class="token punctuation">,</span>
    <span class="token property">&quot;h&quot;</span><span class="token operator">:</span> <span class="token number">56.3</span>
<span class="token punctuation">}</span>
</code></pre></div><p>La seconde partie de code √† modifier est la partie retour. Dans le module 2, vous aviez simplement
√† retourner un JSON au service et la LED sur la board changeait de couleur. Pour cet exercice, il faudra
faire un peu plus de code üòÉ. Vous allez devoir modifier le Device Twin vous-m√™me, √† l'aide d'un des SDK
Service IoT Hub.</p> <blockquote><p>Il existe deux types de SDK IoT Hub :</p> <ul><li>Le <em>Device SDK</em>, pour √™tre utilis√© c√¥t√© objet connect√©</li> <li>Le <em>Service SDK</em>, pour √™tre utilis√© par les applications m√©tiers ayant besoin de communiquer
avec l'IoT Hub.</li></ul> <p>C'est ce second qu'il faudra utiliser. A ce propos, il existe deux chaines de connexion distinctes.
Une pour le device - que vous avez d√©j√† utilis√© - et une autre pour le Service SDK.</p></blockquote> <p>Commencez par choisir le <a href="https://docs.microsoft.com/azure/iot-hub/iot-hub-devguide-sdks?WT.mc_id=msroadshowwinter-event-yolasors#azure-iot-hub-service-sdks" target="_blank" rel="noopener noreferrer">SDK correspondant au langage de votre Azure Function<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>. A ce jour, il existe des SDKs pour Java, NodeJS, Python, .Net, C et iOs. N'h√©sitez pas √† consulter les fichiers
<code>README.md</code> propres √† chaque SDK afin de voir comment les appeler dans votre code.</p> <p>Quelque soit le SDK utilis√©, le principe est le m√™me: nous allons modifier le <em>device twin</em> de
votre board dans IoT Hub, et laisser IoT Hub appliquer la modification sur le p√©riph√©rique.
Ce device twin, qui est au format JSON, devra ressembler √† cela :</p> <div class="language-json extra-class"><pre class="language-json"><code><span class="token punctuation">{</span>
    <span class="token property">&quot;properties&quot;</span><span class="token operator">:</span>
    <span class="token punctuation">{</span>
        <span class="token property">&quot;desired&quot;</span><span class="token operator">:</span> 
            <span class="token punctuation">{</span>
                <span class="token property">&quot;led&quot;</span><span class="token operator">:</span> 
                <span class="token punctuation">{</span>
                    <span class="token property">&quot;r&quot;</span><span class="token operator">:</span> <span class="token number">100</span><span class="token punctuation">,</span>
                    <span class="token property">&quot;g&quot;</span><span class="token operator">:</span> <span class="token number">100</span><span class="token punctuation">,</span>
                    <span class="token property">&quot;b&quot;</span><span class="token operator">:</span> <span class="token number">0</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>Dans votre code, il y aura alors trois √©tapes √† r√©aliser :</p> <ol><li>R√©cup√©rer une instance du <em>Registry Manager</em>, une connection √† l'IoT Hub,</li> <li>R√©cup√©rer la valeur actuelle du Device Twin correspondant √† votre board,</li> <li>Demander une update de ce Device Twin.</li></ol> <p>Voici un exemple de code C# permettant de r√©aliser ces trois √©tapes.</p> <div class="language-csharp extra-class"><pre class="language-csharp"><code><span class="token comment">// Etape 1 - Instance Registry Manager</span>
<span class="token keyword">string</span> connectionString <span class="token operator">=</span> Environment<span class="token punctuation">.</span><span class="token function">GetEnvironmentVariable</span><span class="token punctuation">(</span><span class="token string">&quot;iotHubConnectionString&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">RegistryManager</span> registryManager <span class="token operator">=</span> RegistryManager<span class="token punctuation">.</span><span class="token function">CreateFromConnectionString</span><span class="token punctuation">(</span>connectionString<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// Etape 2 - R√©cup√©ration du twin actuel</span>
<span class="token keyword">var</span> twin <span class="token operator">=</span> <span class="token keyword">await</span> registryManager<span class="token punctuation">.</span><span class="token function">GetTwinAsync</span><span class="token punctuation">(</span>deviceName<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// Etape 3 - Modification du twin</span>
<span class="token keyword">var</span> patch <span class="token operator">=</span> <span class="token keyword">new</span>
<span class="token punctuation">{</span>
    properties <span class="token operator">=</span> <span class="token keyword">new</span>
    <span class="token punctuation">{</span>
        desired <span class="token operator">=</span> <span class="token keyword">new</span>
        <span class="token punctuation">{</span>
            led <span class="token operator">=</span> <span class="token keyword">new</span> 
            <span class="token punctuation">{</span>
                r <span class="token operator">=</span> ledR<span class="token punctuation">,</span>
                g <span class="token operator">=</span> ledG<span class="token punctuation">,</span>
                b <span class="token operator">=</span> ledB
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token keyword">await</span> registryManager<span class="token punctuation">.</span><span class="token function">UpdateTwinAsync</span><span class="token punctuation">(</span>twin<span class="token punctuation">.</span>DeviceId<span class="token punctuation">,</span> JsonConvert<span class="token punctuation">.</span><span class="token function">SerializeObject</span><span class="token punctuation">(</span>patch<span class="token punctuation">)</span><span class="token punctuation">,</span> twin<span class="token punctuation">.</span>ETag<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>Une fois cette derni√®re √©tape r√©alis√©e, vous devriez √™tre en mesure de traiter le message re√ßu de l'Event Hub
puis de modifier le device twin en fonction de votre super algorithme, et ainsi changer la couleur de la LED
par vous m√™me.</p></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ‚Üê
      <a href="/iot-workshop/02-azure-function-detect-activity.html" class="prev">2. D√©tection d'activit√©</a></span> <span class="next"><a href="/iot-workshop/04-simulate-devices.html">(Bonus) Et sans mat√©riel?</a>
      ‚Üí
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/iot-workshop/assets/js/app.8c4c5b71.js" defer></script><script src="/iot-workshop/assets/js/2.7913e008.js" defer></script><script src="/iot-workshop/assets/js/4.4f288e13.js" defer></script>
  </body>
</html>
