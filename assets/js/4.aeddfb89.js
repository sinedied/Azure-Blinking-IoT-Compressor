(window.webpackJsonp=window.webpackJsonp||[]).push([[4],{204:function(e,t,s){e.exports=s.p+"assets/img/schema-arch.95a0412e.png"},252:function(e,t,s){e.exports=s.p+"assets/img/creation-iothub.6016bbcb.gif"},253:function(e,t,s){e.exports=s.p+"assets/img/creation-iotdevice.5d8f4ca0.gif"},254:function(e,t,s){e.exports=s.p+"assets/img/vscode-selectcom.92b0f364.png"},255:function(e,t,s){e.exports=s.p+"assets/img/vscode-selectcom-list.4d25aec3.png"},256:function(e,t,s){e.exports=s.p+"assets/img/vscode-com.2fd3c707.jpg"},257:function(e,t,s){e.exports=s.p+"assets/img/hub-connect-01.c7c5694b.png"},258:function(e,t,s){e.exports=s.p+"assets/img/hub-connect-02.e5728a98.png"},259:function(e,t,s){e.exports=s.p+"assets/img/hub-connect-03.517484a3.png"},260:function(e,t,s){e.exports=s.p+"assets/img/hub-connect-04.4a1c2268.png"},261:function(e,t,s){e.exports=s.p+"assets/img/hub-connect-05.9a476959.png"},262:function(e,t,s){e.exports=s.p+"assets/img/hub-connect-06.68ee67c6.png"},263:function(e,t,s){e.exports=s.p+"assets/img/hub-connect-07.dea355a9.png"},264:function(e,t,s){e.exports=s.p+"assets/img/hub-connect-08.2ef3b62d.png"},265:function(e,t,s){e.exports=s.p+"assets/img/hub-connect-09.f53d4a25.png"},266:function(e,t,s){e.exports=s.p+"assets/img/hub-connect-10.4a6fc17c.png"},267:function(e,t,s){e.exports=s.p+"assets/img/hub-connect-11.337e2a89.png"},268:function(e,t,s){e.exports=s.p+"assets/img/hub-connect-12.c52b0d89.png"},269:function(e,t,s){e.exports=s.p+"assets/img/hub-connect-13.057bfdc0.png"},313:function(e,t,s){"use strict";s.r(t);var n=s(4),r=Object(n.a)({},(function(){var e=this,t=e.$createElement,n=e._self._c||t;return n("ContentSlotsDistributor",{attrs:{"slot-key":e.$parent.slotKey}},[n("h1",{attrs:{id:"connectez-votre-board-a-votre-iot-hub"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#connectez-votre-board-a-votre-iot-hub"}},[e._v("#")]),e._v(" Connectez votre board √† votre IoT Hub")]),e._v(" "),n("p",[e._v("Jusqu'√† pr√©sent, vous avez travaill√© sur une solution IoT qui a d√©j√† √©t√© cr√©√©e pour\nvous √† l'avance. Dans ce module, nous allons voir comment cr√©er une solution IoT\ncompl√®te √† l'aide d'"),n("a",{attrs:{href:"https://docs.microsoft.com/en-us/azure/iot-hub/about-iot-hub?wt.mc_id=blinkingcompressor-github-chmaneu",target:"_blank",rel:"noopener noreferrer"}},[e._v("Azure IoT Hub"),n("OutboundLink")],1),e._v(".\nCe service vous permet de cr√©er de solutions IoT pouvant g√©rer des millions de devices, tout en vous permettant d'abstraire la complexit√© de communication avec\nles devices IoT (Internet public, r√©seaux sigfox ou LoRA, etc...), ainsi que la\ndiversit√© des types de devices (Rasperry Pi, Arduino, microcontr√¥leurs, PC, Mobiles, ...).")]),e._v(" "),n("p",[e._v("Avant de poursuivre, pensez √† installer l'ensemble "),n("RouterLink",{attrs:{to:"/01-prepare-environment.html#module-connectez-vos-devices-iot-au-cloud"}},[e._v("des pr√©requis")]),e._v(" n√©cessaires √† cette partie. Ils seront n√©cessaires afin de reconfigurer votre board pour qu'elle communique avec l'IoT Hub que vous allez cr√©er.")],1),e._v(" "),n("ul",[n("li",[e._v("Cr√©er les ressources dans Azure")]),e._v(" "),n("li",[e._v("Reconfigurer votre board")]),e._v(" "),n("li",[e._v("Connectez votre fonction √† votre IoT Hub")]),e._v(" "),n("li",[e._v("Acc√©dez a vos devices depuis Visual Studio Code")])]),e._v(" "),n("h2",{attrs:{id:"creer-un-iot-hub"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#creer-un-iot-hub"}},[e._v("#")]),e._v(" Cr√©er un IoT Hub")]),e._v(" "),n("p",[e._v("L'IoT Hub est un service qui vous permet de g√©rer la connexion entre vos devices IoT et vos services h√©berg√©s sur Azure\n(ou ailleurs). Plus concr√®tement, il vous permet :")]),e._v(" "),n("ul",[n("li",[e._v("D'identifier et de recevoir des donn√©es de vos p√©riph√©riques IoT - on appelle cela le "),n("em",[e._v("Device To Cloud")]),e._v(",")]),e._v(" "),n("li",[e._v("D'envoyer ces donn√©es √† diff√©rents applicatifs,")]),e._v(" "),n("li",[e._v("De transmettre des commandes ou des donn√©es du cloud vers vos p√©riph√©riques - c'est le "),n("em",[e._v("Cloud To Device")]),e._v(",")]),e._v(" "),n("li",[e._v("De mettre √† jour les micrologiciels √† distance de vos p√©riph√©riques, voire de d√©ployer du code √† distance.")])]),e._v(" "),n("p",[e._v("La vid√©o suivante nous montre comment cr√©er un nouveau IoT Hub. Choisissez bien le groupe de ressources cr√©√© √† l'√©tape\npr√©c√©dente, puis choisissez la r√©gion (Europe occidentale) puis un nom.")]),e._v(" "),n("blockquote",[n("p",[e._v("Comme beaucoup de ressources dans Azure, leur nom devient une partie d'une adresse Internet - ici\n"),n("code",[e._v("monhub.chris-ioth.azure-devices.net")]),e._v(". Il doit donc √™tre unique √† tous les utilisateurs d'Azure !")])]),e._v(" "),n("p",[e._v("A l'√©tape d'apr√®s, vous serez amen√© √† choisir un niveau de tarification ("),n("em",[e._v("tier")]),e._v(") et une mise √† l'√©chelle. Pour cet\natelier, nous choisirons la taille "),n("strong",[e._v("S1: Niveau Standard")]),e._v(".")]),e._v(" "),n("blockquote",[n("p",[e._v("Il existe √† aujourd'hui trois tiers. Le tiers gratuit est limit√© en nombre de messages, alors que le tiers basique ne\ndispose pas des fonctionnalit√©s "),n("em",[e._v("Cloud to Device")]),e._v(" ou "),n("em",[e._v("Device Twins")]),e._v(" que nous allons utiliser plus loin. Le nombre\nd'unit√©s permet quand √† lui de supporter un plus grand nombre de p√©riph√©riques IoT.")])]),e._v(" "),n("p",[n("img",{attrs:{src:s(252),alt:"Video - Cr√©ation d'un IoT Hub"}})]),e._v(" "),n("p",[e._v("Maintenant que votre hub est cr√©√©, il vous reste √† effectuer deux √©tapes :")]),e._v(" "),n("ul",[n("li",[e._v("Connecter votre carte √† l'IoT Hub que vous venez de cr√©er")]),e._v(" "),n("li",[e._v("Traiter les messages re√ßus par votre IoT Hub")])]),e._v(" "),n("h2",{attrs:{id:"connecter-votre-carte-iot-a-iot-hub-üîå"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#connecter-votre-carte-iot-a-iot-hub-üîå"}},[e._v("#")]),e._v(" Connecter votre carte IoT √† IoT Hub üîå")]),e._v(" "),n("h3",{attrs:{id:"creer-un-device-dans-l-iot-hub"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#creer-un-device-dans-l-iot-hub"}},[e._v("#")]),e._v(" Cr√©er un "),n("em",[e._v("device")]),e._v(" dans l'IoT Hub")]),e._v(" "),n("p",[e._v("Au sein du IoT Hub, chacun de vos p√©riph√©riques IoT se doit d'√™tre d√©clar√© afin de pouvoir le g√©rer et accepter des\ndonn√©es. Pour cet atelier simple, nous allons ajouter le p√©riph√©rique √† la main. Si nous avions √† d√©ployer des millions\nde p√©riph√©riques, il y a bien √©videmment "),n("a",{attrs:{href:"https://docs.microsoft.com/fr-fr/azure/iot-dps/?wt.mc_id=devroadshowiot-github-chmaneu",target:"_blank",rel:"noopener noreferrer"}},[e._v("une solution"),n("OutboundLink")],1),e._v(" üòÉ Et comme tout service Azure, il existe une\nAPI Rest - et souvent un SDK - qui permet "),n("a",{attrs:{href:"https://github.com/cmaneu/Azure-Blinking-IoT-Compressor/blob/master/src/functions-dispatcher/CreateDevice.cs",target:"_blank",rel:"noopener noreferrer"}},[e._v("d'automatiser certaines t√¢ches"),n("OutboundLink")],1),e._v(".")]),e._v(" "),n("p",[e._v("La cr√©ation d'un device IoT dans le portail est assez simple. Naviguez jusqu'√† l'onglet "),n("strong",[e._v("Appareils IoT")]),e._v(" (IoT Devices), puis cliquez\nsur "),n("strong",[e._v("Ajouter")]),e._v(". Vous avez alors simplement √† donner un nom √† votre p√©riph√©rique. Pour notre workshop, il n'y a bas besoin de\nconfigurer les autres options.")]),e._v(" "),n("p",[n("img",{attrs:{src:s(253),alt:"Video - Cr√©ation d'un p√©riph√©rique IoT Hub"}})]),e._v(" "),n("p",[e._v("Lorsque vous vous rendez sur l'√©cran de votre appareil IoT - en cliquant sur son nom - , vous aurez acc√®s √† deux cl√©s ainsi que les cha√Ænes de connexion correspondantes. "),n("strong",[e._v("Ce sont elles qui permettent de s√©curiser la connexion entre votre appareil et Azure")]),e._v(".")]),e._v(" "),n("div",{staticClass:"custom-block warning"},[n("p",{staticClass:"custom-block-title"},[e._v("Attention")]),e._v(" "),n("p",[e._v("Il est important "),n("strong",[e._v("de ne pas les diffuser ou les mettre dans votre code source (ou repository Github)")]),e._v(". Nous verrons juste apr√®s comment la d√©ployer sur la carte.")])]),e._v(" "),n("div",{staticClass:"custom-block tip"},[n("p",{staticClass:"custom-block-title"},[e._v("Note")]),e._v(" "),n("p",[n("strong",[e._v("Pourquoi il y a-t-il deux cl√©s et non pas une ?")]),e._v(" C'est pour permettre la rotation de cl√©s, une bonne pratique en mati√®re de s√©curit√©.")])]),e._v(" "),n("p",[n("strong",[e._v("Notez cette cl√© d'acc√®s quelque part")]),e._v(" ou gardez la fen√™tre ouverte, nous allons l'utiliser dans quelques instants.")]),e._v(" "),n("h3",{attrs:{id:"configurer-la-chaine-de-connection-sur-votre-board"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#configurer-la-chaine-de-connection-sur-votre-board"}},[e._v("#")]),e._v(" Configurer la cha√Æne de connection sur votre board")]),e._v(" "),n("p",[e._v("Il faut maintenant "),n("em",[e._v("donner")]),e._v(" cette cl√© d'acc√®s √† la board. Il existe un emplacement m√©moire sp√©cifique permettant de contenir ce genre d'informations.")]),e._v(" "),n("div",{staticClass:"custom-block tip"},[n("p",{staticClass:"custom-block-title"},[e._v("Note")]),e._v(" "),n("p",[e._v("La board "),n("em",[e._v("MXChip")]),e._v(" poss√®de une puce de s√©curit√©, permettant notamment de prot√©ger ce genre de secrets, y compris\nsi le firmware √©tait corrompu. Sa mise en oeuvre prendrait un peu de temps, et elle est irr√©versible. Les boards\nque nous vous pr√™tons pour le workshop √©tant r√©utilis√©es, nous n'utiliserons pas cette fonctionnalit√©.")])]),e._v(" "),n("p",[e._v("Visual Studio Code a une fonctionnalit√© vous permettant tr√®s simplement d'uploader sur la board cette configuration.\nCependant, celle-ci n'est disponible que lorsque vous avez un projet "),n("em",[e._v("IoT Workbench")]),e._v('. Nous allons cr√©er un projet\n"vide". Ouvrez une nouvelle instance de Visual Studio Code, et effectuez les √©tapes suivantes:')]),e._v(" "),n("ul",[n("li",[n("strong",[e._v("Azure IoT Device Workbench: Create Project...")])]),e._v(" "),n("li",[e._v("Donner un nom")]),e._v(" "),n("li",[e._v("Le type de board, s√©lectionner "),n("strong",[e._v("Arduino")])]),e._v(" "),n("li",[e._v("Template de projet: choisir "),n("strong",[e._v("MXChip IoT DevKit with Azure IoT Hub")])])]),e._v(" "),n("p",[e._v("Assurez-vous que Visual Studio a bien s√©lectionn√© votre type de board ainsi que le port s√©rie (√©mul√© via l'USB).\nVous pouvez voir en bas √† droite le port s√©lectionn√©. Sur l'image ci-dessous, aucun port n'est s√©lectionn√©.")]),e._v(" "),n("p",[n("img",{attrs:{src:s(254),alt:""}})]),e._v(" "),n("p",[e._v("Cliquez sur "),n("code",[e._v("<Select Serial Port>")]),e._v(" et s√©lectionnez le port COM avec la l√©gende "),n("em",[e._v("ST Microelectronics")]),e._v(".")]),e._v(" "),n("p",[n("img",{attrs:{src:s(255),alt:""}})]),e._v(" "),n("p",[e._v("Le port s√©lectionn√© s'affiche alors en bas √† droite.")]),e._v(" "),n("p",[n("img",{attrs:{src:s(256),alt:"S√©lecteur Visual Studio Code de board et de port s√©rie"}})]),e._v(" "),n("p",[e._v("Vous pouvez d√©sormais uploader la cha√Æne de connexion sur la board. Pour se faire :")]),e._v(" "),n("ol",[n("li",[e._v("Maintenez appuy√© le bouton "),n("strong",[e._v("A")]),e._v(" puis appuyez et rel√¢chez le bouton "),n("strong",[e._v("reset")]),e._v(" pour passer en mode configuration")]),e._v(" "),n("li",[e._v("A l'aide de la commande "),n("code",[e._v("Azure IoT Device Workbench: Configure Device Settings")]),e._v(", choisissez "),n("code",[e._v("Config Device Connection String")]),e._v(",\npuis "),n("code",[e._v("Input IoT Hub Device Connection String")]),e._v(", et collez la connection string compl√®te g√©n√©r√©e au d√©but de l'atelier.")])]),e._v(" "),n("p",[e._v("Une notification de confirmation va appara√Ætre dans Visual Studio Code. Vous pouvez maintenant red√©marrer votre board.")]),e._v(" "),n("h3",{attrs:{id:"tester-la-connexion-entre-les-deux"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#tester-la-connexion-entre-les-deux"}},[e._v("#")]),e._v(" Tester la connexion entre les deux")]),e._v(" "),n("p",[e._v("Une fois que votre board a red√©marr√©e - vous pouvez appuyer sur le bouton physique "),n("strong",[e._v("reset")]),e._v(" pour le forcer, vous pouvez voir sur l'√©cran de la board si les envois de messages sont r√©ussis. Le message "),n("code",[e._v("Update #99 sent")]),e._v("\nappara√Æt alors (avec un num√©ro s√©quentiel √† la place de 99).")]),e._v(" "),n("p",[e._v("Dans la prochaine √©tape, nous allons reconnecter votre Azure Function avec IoT Hub pour qu'elle\ntraite les messages.")]),e._v(" "),n("h2",{attrs:{id:"traiter-les-evenement-du-hub-avec-azure-functions"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#traiter-les-evenement-du-hub-avec-azure-functions"}},[e._v("#")]),e._v(" Traiter les √©v√©nement du Hub avec Azure Functions")]),e._v(" "),n("p",[e._v("Jusqu'√† pr√©sent, nous vous avions abstrait une partie de la complexit√© - et des services -\nn√©cessaires pour r√©aliser l'architecture. Comme vous pouvez le voir sur le sch√©ma ci-dessous,\nune Azure Function ne peut pas consommer directement des messages provenant de l'IoT Hub.")]),e._v(" "),n("p",[e._v("Pour se faire, nous devons passer par un autre service, "),n("strong",[e._v("Azure Event Hubs")]),e._v(". C'est un service\nd'ingestion de donn√©es en temps r√©el, simple et hautement scalable (on peut parler facilement\nde millions d'√©v√©nements par seconde). L'API est propri√©taire (avec des SDK opensources pour\nde nombreux langages), mais il est √©galement possible de l'utiliser avec une API Kafka\n(Event Hubs peut donc √™tre utilis√© comme un service Kafka enti√®rement manag√© !).")]),e._v(" "),n("p",[n("img",{attrs:{src:s(204),alt:""}})]),e._v(" "),n("h3",{attrs:{id:"creer-un-event-hub"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#creer-un-event-hub"}},[e._v("#")]),e._v(" Cr√©er un Event Hub")]),e._v(" "),n("p",[e._v("Pour utiliser un event hub, vous avez besoin de deux composants :")]),e._v(" "),n("ul",[n("li",[e._v("Un Namespace : C'est un conteneur pour un Event Hub (tel qu'un topic kafka).")]),e._v(" "),n("li",[e._v("Un Event Hub : C'est l'unit√© de scaling/processing des messages.")])]),e._v(" "),n("p",[e._v("Commencez par cr√©er un namespace, via le menu de cr√©ation de ressources. Vous pouvez choisir\nle m√™me ressource group que pr√©c√©demment. Choisissez √©galement la m√™me r√©gion que celle de votre IoT Hub\net Azure Function.")]),e._v(" "),n("p",[n("img",{attrs:{src:s(257),alt:""}})]),e._v(" "),n("p",[e._v("Une fois cr√©√©, il vous faudra alors cr√©er l'Event Hub. Vous pouvez le faire via le bouton "),n("strong",[e._v("+ Event Hub")]),e._v(" sur\nla ressource Namespace.")]),e._v(" "),n("p",[n("img",{attrs:{src:s(258),alt:""}}),e._v(" "),n("img",{attrs:{src:s(259),alt:""}})]),e._v(" "),n("h3",{attrs:{id:"configurer-l-envoi-des-messages-de-l-iot-hub-vers-l-event-hub"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#configurer-l-envoi-des-messages-de-l-iot-hub-vers-l-event-hub"}},[e._v("#")]),e._v(" Configurer l'envoi des messages de l'IoT Hub vers l'Event Hub")]),e._v(" "),n("p",[e._v("Nous allons maintenant indiquer √† l'IoT Hub qu'il doit envoyer les donn√©es qu'il re√ßoit\nvers l'Event Hub que nous avons cr√©√©. Pour cela, retournez sur votre ressource IoT Hub, et\ncliquez sur "),n("strong",[e._v("Message routing")]),e._v(" dans le menu de gauche.")]),e._v(" "),n("p",[n("img",{attrs:{src:s(260),alt:""}})]),e._v(" "),n("blockquote",[n("p",[e._v("L'exercice ici est tr√®s simple. Pour un d√©ploiement en production, il faudrait ajuster un certain nombre\nde param√®tres en fonction du nombre de devices ainsi que du nombre de flux consommant les donn√©es\nde l'IoT Hub - et notamment avoir le nombre de partitions en cons√©quence.")])]),e._v(" "),n("p",[e._v("Vous pouvez alors ajouter une route. Il faudra choisir un nouveau endpoint de type Event Hubs.\nAssurez-vous de router les messages de type "),n("code",[e._v("Device Telemetry Message")]),e._v(".")]),e._v(" "),n("p",[n("img",{attrs:{src:s(261),alt:""}}),e._v(" "),n("img",{attrs:{src:s(262),alt:""}})]),e._v(" "),n("p",[e._v("A partir de maintenant, tous les messages re√ßus des devices par l'IoT Hub seront renvoy√©s\nvers l'Event hubs.")]),e._v(" "),n("blockquote",[n("p",[e._v("Vous avez un peu de temps ? Cr√©ez un compte de stockage, et une route suppl√©mentaire afin\nd'envoyer √©galement les messages sur un stockage √† froid pour une analyse √† post√©riori.")])]),e._v(" "),n("h3",{attrs:{id:"developper-l-azure-function-pour-consommer-les-messages-de-l-event-hub"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#developper-l-azure-function-pour-consommer-les-messages-de-l-event-hub"}},[e._v("#")]),e._v(" D√©velopper l'Azure Function pour consommer les messages de l'Event Hub")]),e._v(" "),n("p",[e._v("Il nous faut d√©sormais consommer les messages provanent de l'Event Hub. Le plus simple pour cela\nest de cr√©er une nouvelle fonction - par exemple dans la m√™me app que celle cr√©√©e lors du module 2.")]),e._v(" "),n("p",[e._v("Vous pouvez reprendre votre projet Azure Functions et refaire les √©tapes en s√©lectionnant le trigger\n"),n("code",[e._v("Event Hubs")]),e._v(". Visual Studio Code vous proposera alors de s√©lectionner l'Event Hub que vous souhaitez\nconsommer.")]),e._v(" "),n("p",[n("img",{attrs:{src:s(263),alt:""}}),e._v(" "),n("img",{attrs:{src:s(264),alt:""}}),e._v(" "),n("img",{attrs:{src:s(265),alt:""}}),e._v(" "),n("img",{attrs:{src:s(266),alt:""}}),e._v(" "),n("img",{attrs:{src:s(267),alt:""}}),e._v(" "),n("img",{attrs:{src:s(268),alt:""}}),e._v(" "),n("img",{attrs:{src:s(269),alt:""}})]),e._v(" "),n("p",[e._v("Vous pouvez r√©utiliser le code cr√©√© lors du module 2, mais avec quelques adaptations üòÉ.\nTout d'abord, le message que vous allez recevoir a un format diff√©rent de celui re√ßu au module 2.\nVoici un exemple de JSON que vous allez re√ßevoir :")]),e._v(" "),n("div",{staticClass:"language-json extra-class"},[n("pre",{pre:!0,attrs:{class:"language-json"}},[n("code",[n("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("{")]),e._v("\n    "),n("span",{pre:!0,attrs:{class:"token property"}},[e._v('"Topic"')]),n("span",{pre:!0,attrs:{class:"token operator"}},[e._v(":")]),e._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[e._v('"iot"')]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(",")]),e._v(" \n    "),n("span",{pre:!0,attrs:{class:"token property"}},[e._v('"t"')]),n("span",{pre:!0,attrs:{class:"token operator"}},[e._v(":")]),e._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[e._v("25.5")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(",")]),e._v("\n    "),n("span",{pre:!0,attrs:{class:"token property"}},[e._v('"p"')]),n("span",{pre:!0,attrs:{class:"token operator"}},[e._v(":")]),e._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[e._v("1003.3")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(",")]),e._v("\n    "),n("span",{pre:!0,attrs:{class:"token property"}},[e._v('"h"')]),n("span",{pre:!0,attrs:{class:"token operator"}},[e._v(":")]),e._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[e._v("56.3")]),e._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("}")]),e._v("\n")])])]),n("p",[e._v("La seconde partie de code √† modifier est la partie retour. Dans le module 2, vous aviez simplement\n√† retourner un JSON au service et la LED sur la board changeait de couleur. Pour cet exercice, il faudra\nfaire un peu plus de code üòÉ. Vous allez devoir modifier le Device Twin vous-m√™me, √† l'aide d'un des SDK\nService IoT Hub.")]),e._v(" "),n("blockquote",[n("p",[e._v("Il existe deux types de SDK IoT Hub :")]),e._v(" "),n("ul",[n("li",[e._v("Le "),n("em",[e._v("Device SDK")]),e._v(", pour √™tre utilis√© c√¥t√© objet connect√©")]),e._v(" "),n("li",[e._v("Le "),n("em",[e._v("Service SDK")]),e._v(", pour √™tre utilis√© par les applications m√©tiers ayant besoin de communiquer\navec l'IoT Hub.")])]),e._v(" "),n("p",[e._v("C'est ce second qu'il faudra utiliser. A ce propos, il existe deux chaines de connexion distinctes.\nUne pour le device - que vous avez d√©j√† utilis√© - et une autre pour le Service SDK.")])]),e._v(" "),n("p",[e._v("Commencez par choisir le "),n("a",{attrs:{href:"https://docs.microsoft.com/en-us/azure/iot-hub/iot-hub-devguide-sdks?wt.mc_id=blinkingcompressor-github-chmaneu#azure-iot-hub-service-sdks",target:"_blank",rel:"noopener noreferrer"}},[e._v("SDK correspondant au langage de votre Azure Function"),n("OutboundLink")],1),e._v(". A ce jour, il existe des SDKs pour Java, NodeJS, Python, .Net, C et iOs. N'h√©sitez pas √† consulter les fichiers\n"),n("code",[e._v("README.md")]),e._v(" propres √† chaque SDK afin de voir comment les appeler dans votre code.")]),e._v(" "),n("p",[e._v("Quelque soit le SDK utilis√©, le principe est le m√™me: nous allons modifier le "),n("em",[e._v("device twin")]),e._v(" de\nvotre board dans IoT Hub, et laisser IoT Hub appliquer la modification sur le p√©riph√©rique.\nCe device twin, qui est au format JSON, devra ressembler √† cela :")]),e._v(" "),n("div",{staticClass:"language-json extra-class"},[n("pre",{pre:!0,attrs:{class:"language-json"}},[n("code",[n("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("{")]),e._v("\n    "),n("span",{pre:!0,attrs:{class:"token property"}},[e._v('"properties"')]),n("span",{pre:!0,attrs:{class:"token operator"}},[e._v(":")]),e._v("\n    "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("{")]),e._v("\n        "),n("span",{pre:!0,attrs:{class:"token property"}},[e._v('"desired"')]),n("span",{pre:!0,attrs:{class:"token operator"}},[e._v(":")]),e._v(" \n            "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("{")]),e._v("\n                "),n("span",{pre:!0,attrs:{class:"token property"}},[e._v('"led"')]),n("span",{pre:!0,attrs:{class:"token operator"}},[e._v(":")]),e._v(" \n                "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("{")]),e._v("\n                    "),n("span",{pre:!0,attrs:{class:"token property"}},[e._v('"r"')]),n("span",{pre:!0,attrs:{class:"token operator"}},[e._v(":")]),e._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[e._v("100")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(",")]),e._v("\n                    "),n("span",{pre:!0,attrs:{class:"token property"}},[e._v('"g"')]),n("span",{pre:!0,attrs:{class:"token operator"}},[e._v(":")]),e._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[e._v("100")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(",")]),e._v("\n                    "),n("span",{pre:!0,attrs:{class:"token property"}},[e._v('"b"')]),n("span",{pre:!0,attrs:{class:"token operator"}},[e._v(":")]),e._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[e._v("0")]),e._v("\n                "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("}")]),e._v("\n            "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("}")]),e._v("\n    "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("}")]),e._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("}")]),e._v("\n")])])]),n("p",[e._v("Dans votre code, il y aura alors trois √©tapes √† r√©aliser :")]),e._v(" "),n("ol",[n("li",[e._v("R√©cup√©rer une instance du "),n("em",[e._v("Registry Manager")]),e._v(", une connection √† l'IoT Hub,")]),e._v(" "),n("li",[e._v("R√©cup√©rer la valeur actuelle du Device Twin correspondant √† votre board,")]),e._v(" "),n("li",[e._v("Demander une update de ce Device Twin.")])]),e._v(" "),n("p",[e._v("Voici un exemple de code C# permettant de r√©aliser ces trois √©tapes.")]),e._v(" "),n("div",{staticClass:"language-csharp extra-class"},[n("pre",{pre:!0,attrs:{class:"language-csharp"}},[n("code",[n("span",{pre:!0,attrs:{class:"token comment"}},[e._v("// Etape 1 - Instance Registry Manager")]),e._v("\n"),n("span",{pre:!0,attrs:{class:"token keyword"}},[e._v("string")]),e._v(" connectionString "),n("span",{pre:!0,attrs:{class:"token operator"}},[e._v("=")]),e._v(" Environment"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[e._v("GetEnvironmentVariable")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("(")]),n("span",{pre:!0,attrs:{class:"token string"}},[e._v('"iotHubConnectionString"')]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(";")]),e._v("\n"),n("span",{pre:!0,attrs:{class:"token class-name"}},[e._v("RegistryManager")]),e._v(" registryManager "),n("span",{pre:!0,attrs:{class:"token operator"}},[e._v("=")]),e._v(" RegistryManager"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[e._v("CreateFromConnectionString")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("(")]),e._v("connectionString"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(";")]),e._v("\n\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[e._v("// Etape 2 - R√©cup√©ration du twin actuel")]),e._v("\n"),n("span",{pre:!0,attrs:{class:"token keyword"}},[e._v("var")]),e._v(" twin "),n("span",{pre:!0,attrs:{class:"token operator"}},[e._v("=")]),e._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[e._v("await")]),e._v(" registryManager"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[e._v("GetTwinAsync")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("(")]),e._v("deviceName"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(";")]),e._v("\n\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[e._v("// Etape 3 - Modification du twin")]),e._v("\n"),n("span",{pre:!0,attrs:{class:"token keyword"}},[e._v("var")]),e._v(" patch "),n("span",{pre:!0,attrs:{class:"token operator"}},[e._v("=")]),e._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[e._v("new")]),e._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("{")]),e._v("\n    properties "),n("span",{pre:!0,attrs:{class:"token operator"}},[e._v("=")]),e._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[e._v("new")]),e._v("\n    "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("{")]),e._v("\n        desired "),n("span",{pre:!0,attrs:{class:"token operator"}},[e._v("=")]),e._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[e._v("new")]),e._v("\n        "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("{")]),e._v("\n            led "),n("span",{pre:!0,attrs:{class:"token operator"}},[e._v("=")]),e._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[e._v("new")]),e._v(" \n            "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("{")]),e._v("\n                r "),n("span",{pre:!0,attrs:{class:"token operator"}},[e._v("=")]),e._v(" ledR"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(",")]),e._v("\n                g "),n("span",{pre:!0,attrs:{class:"token operator"}},[e._v("=")]),e._v(" ledG"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(",")]),e._v("\n                b "),n("span",{pre:!0,attrs:{class:"token operator"}},[e._v("=")]),e._v(" ledB\n            "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("}")]),e._v("\n        "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("}")]),e._v("\n    "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("}")]),e._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("}")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(";")]),e._v("\n"),n("span",{pre:!0,attrs:{class:"token keyword"}},[e._v("await")]),e._v(" registryManager"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[e._v("UpdateTwinAsync")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("(")]),e._v("twin"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(".")]),e._v("DeviceId"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(",")]),e._v(" JsonConvert"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[e._v("SerializeObject")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("(")]),e._v("patch"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(",")]),e._v(" twin"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(".")]),e._v("ETag"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(";")]),e._v("\n")])])]),n("p",[e._v("Une fois cette derni√®re √©tape r√©alis√©e, vous devriez √™tre en mesure de traiter le message re√ßu de l'Event Hub\npuis de modifier le device twin en fonction de votre super algorithme, et ainsi changer la couleur de la LED\npar vous m√™me.")])])}),[],!1,null,null,null);t.default=r.exports}}]);