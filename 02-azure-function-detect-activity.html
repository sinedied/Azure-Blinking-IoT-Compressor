<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>2. D√©tection d&#39;activit√© | Azure IoT workshop</title>
    <meta name="description" content="">
    <meta name="generator" content="VuePress 1.3.0">
    <link rel="icon" href="/iot-workshop/bit-iot.png">
  <meta name="theme-color" content="#0078d7">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black">
  <meta name="msapplication-TileColor" content="#0078d7">
    <meta property="og:image" content="https://sinedied.github.io/iot-workshop/bit-iot.png"><meta name="twitter:image" content="https://sinedied.github.io/iot-workshop/bit-iot.png"><meta property="og:url" content="https://sinedied.github.io/iot-workshop/02-azure-function-detect-activity.html"><meta name="twitter:url" content="https://sinedied.github.io/iot-workshop/02-azure-function-detect-activity.html"><meta property="og:title" content="2. D√©tection d&#39;activit√©"><meta name="twitter:title" content="2. D√©tection d&#39;activit√©"><meta itemprop="name" content="2. D√©tection d&#39;activit√©"><meta property="og:type" content="website"><meta name="twitter:card" content="summary"><meta property="og:site_name" content="Azure IoT Workshop"><meta name="twitter:site" content="@chmaneu"><meta name="twitter:creator" content="@chmaneu">
    <link rel="preload" href="/iot-workshop/assets/css/0.styles.694f9356.css" as="style"><link rel="preload" href="/iot-workshop/assets/js/app.8c4c5b71.js" as="script"><link rel="preload" href="/iot-workshop/assets/js/2.7913e008.js" as="script"><link rel="preload" href="/iot-workshop/assets/js/3.091fb9b7.js" as="script"><link rel="prefetch" href="/iot-workshop/assets/js/10.c111af0d.js"><link rel="prefetch" href="/iot-workshop/assets/js/11.d79f0cb7.js"><link rel="prefetch" href="/iot-workshop/assets/js/12.3f0b14c3.js"><link rel="prefetch" href="/iot-workshop/assets/js/13.67a9e161.js"><link rel="prefetch" href="/iot-workshop/assets/js/14.3e43ca60.js"><link rel="prefetch" href="/iot-workshop/assets/js/15.1b268ab3.js"><link rel="prefetch" href="/iot-workshop/assets/js/4.4f288e13.js"><link rel="prefetch" href="/iot-workshop/assets/js/5.0b37f156.js"><link rel="prefetch" href="/iot-workshop/assets/js/6.70392e21.js"><link rel="prefetch" href="/iot-workshop/assets/js/7.667c89ef.js"><link rel="prefetch" href="/iot-workshop/assets/js/8.6cd0e39e.js"><link rel="prefetch" href="/iot-workshop/assets/js/9.16f58e21.js">
    <link rel="stylesheet" href="/iot-workshop/assets/css/0.styles.694f9356.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/iot-workshop/" class="home-link router-link-active"><img src="/iot-workshop/bit-iot.png" alt="Azure IoT workshop" class="logo"> <span class="site-name can-hide">Azure IoT workshop</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="https://github.com/sinedied/iot-workshop" target="_blank" rel="noopener noreferrer" class="nav-link external">
  GitHub
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="https://github.com/sinedied/iot-workshop" target="_blank" rel="noopener noreferrer" class="nav-link external">
  GitHub
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <!----></nav>  <ul class="sidebar-links"><li><a href="/iot-workshop/" class="sidebar-link">Introduction</a></li><li><a href="/iot-workshop/01-prepare-environment.html" class="sidebar-link">1. Pr√©paration</a></li><li><a href="/iot-workshop/02-azure-function-detect-activity.html" class="active sidebar-link">2. D√©tection d'activit√©</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/iot-workshop/02-azure-function-detect-activity.html#creer-une-fonction-dans-vs-code" class="sidebar-link">Cr√©er une Fonction dans VS Code</a></li><li class="sidebar-sub-header"><a href="/iot-workshop/02-azure-function-detect-activity.html#creer-une-azure-function-‚ö°-dans-le-portail-azure-üë©‚Äçüíª" class="sidebar-link">Cr√©er une Azure Function ‚ö° dans le portail Azure üë©‚Äçüíª</a></li><li class="sidebar-sub-header"><a href="/iot-workshop/02-azure-function-detect-activity.html#ecrire-du-code-pour-detecter-l-activite-du-compresseur" class="sidebar-link">Ecrire du code pour d√©tecter l'activit√© du compresseur</a></li><li class="sidebar-sub-header"><a href="/iot-workshop/02-azure-function-detect-activity.html#deployez-votre-fonction-dans-azure-‚òÅÔ∏è" class="sidebar-link">D√©ployez votre fonction dans Azure ‚òÅÔ∏è</a></li><li class="sidebar-sub-header"><a href="/iot-workshop/02-azure-function-detect-activity.html#connectez-votre-function-a-tailwind-diving-üè≠" class="sidebar-link">Connectez votre function √† Tailwind Diving üè≠</a></li></ul></li><li><a href="/iot-workshop/03-connect-iot-devices-hub.html" class="sidebar-link">3. Connection au cloud</a></li><li><a href="/iot-workshop/04-simulate-devices.html" class="sidebar-link">(Bonus) Et sans mat√©riel?</a></li><li><a href="/iot-workshop/whats-next.html" class="sidebar-link">Et apr√®s ?</a></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="detectez-l-activite-du-compresseur-avec-azure-functions"><a href="#detectez-l-activite-du-compresseur-avec-azure-functions" class="header-anchor">#</a> D√©tectez l'activit√© du compresseur avec Azure Functions</h1> <blockquote><p>Si vous r√©alisez ce workshop seul, sans quelqu'un de l'√©quipe relations
d√©veloppeurs, alors il vous faudra r√©aliser le module 3 &quot;Connectez vos devices
IoT au Cloud&quot; avant de r√©aliser ce module.</p></blockquote> <h3 id="ce-que-l-on-cherche-a-realiser"><a href="#ce-que-l-on-cherche-a-realiser" class="header-anchor">#</a> Ce que l'on cherche √† r√©aliser</h3> <p>Nous avons d√©j√† connect√© les boards au cloud pour vous (vous pourrez le faire
vous-m√™me dans le prochain module). Nous avons besoin de vous afin de d√©tecter
d'apr√®s les donn√©es des capteurs si le compresseur est en fonctionnement ou non.</p> <p>Vous allez donc d√©velopper une API REST √† l'aide d'Azure Functions qui sera appel√©e
d√®s que la carte IoT enverra une nouvelle donn√©e. A vous de cr√©er un super algo
qui retournera l'√©tat du compresseur üòÄ.</p> <h3 id="qu-est-ce-qu-azure-function"><a href="#qu-est-ce-qu-azure-function" class="header-anchor">#</a> Qu'est ce qu'Azure Function ?</h3> <p>Azure Functions est un des services <em>serverless</em> d'Azure. Il vous permet de d√©velopper
des &quot;fonctions&quot; de code qui seront ex√©cut√©es √† la demande, avec un paiement √† l'usage
ainsi qu'un auto-scaling.</p> <p>Il est possible de d√©velopper des Azure Functions avec un ensemble de langages: Java, Python, C#, Node.JS, etc...
Une fois d√©velopp√©, les Azure Functions peuvent √™tre h√©berg√©es sur Azure, mais √©galement sur d'autres clouds, sur
vos serveurs - via une image Docker - et m√™me sur des devices IoT !</p> <h3 id="comment-developper-une-azure-function"><a href="#comment-developper-une-azure-function" class="header-anchor">#</a> Comment d√©velopper une Azure Function ?</h3> <p>Vous avez deux possibilit√©s pour d√©velopper une Azure Function :</p> <ul><li><strong>Via le portail Azure</strong>: avec une exp√©rience enti√®rement dans votre navigateur. Cela est pratique
pour faire quelques tests, ou un petit PoC,</li> <li><strong>Sur votre poste de d√©veloppement (Windows, Mac, Linux)</strong>: avec Visual Studio ou Visual Studio Code. C'est
la solution recommand√©e pour des projets de production.</li></ul> <h2 id="creer-une-fonction-dans-vs-code"><a href="#creer-une-fonction-dans-vs-code" class="header-anchor">#</a> Cr√©er une Fonction dans VS Code</h2> <p>Visual Studio Code vous permet de cr√©er et de tester votre code en local, souvent sans acc√®s √† Internet. Il est ensuite
possible de d√©ployer directement votre code dans une Azure function, ou via un pipeline d'int√©gration/d√©ploiement continu.</p> <p>Si vous n'avez pas Visual Studio Code, vous pouvez √©galement <a href="#creer-une-azure-function-%E2%9A%A1-dans-le-portail-azure-%F0%9F%91%A9%E2%80%8D%F0%9F%92%BB">d√©velopper votre fonction dans le portail Azure</a>.</p> <h3 id="creer-le-projet"><a href="#creer-le-projet" class="header-anchor">#</a> Cr√©er le projet</h3> <p>Pour cr√©er un projet Azure Functions, lancez la barre de commandes (<em>Ctrl+Shift+P</em>), et recherchez la commande
<code>Azure Functions: Create New Project...</code>. Choisissez un r√©pertoire vide et r√©pondez aux options de cr√©ation du projet:</p> <ul><li><strong>Le langage</strong>: Vous pouvez choisir n'importe quel langage pour ce projet,</li> <li><strong>Le trigger</strong>: C'est l'√©l√©ment qui va venir d√©clencher l'ex√©cution de votre fonction. Dans le cas d'une API REST, il
faudra s√©lectionner <em>HTTP trigger</em>,</li> <li><strong>Un nom de fonction</strong>: Ce nom doit √™tre pr√©dictif (j'ai choisi <code>prediction</code>). Par d√©faut, ce sera √©galement une partie
de l'URL</li> <li><strong>Le type d'autorisation</strong>: Est-ce que votre fonction doit √™tre accessible sans authentification, ou avec une cl√©. Pour
ce workshop, vous √™tes libres de choisir l'une des deux m√©thodes, mais je vous encourage √† s√©lectionner <em>Function</em>. Prenons
de bonnes habitudes üòÉ.</li> <li><strong>Comment souhaitez-vous ouvrir le projet</strong>: dans une nouvelle fen√™tre VS Code ou dans la m√™me.</li></ul> <div class="img-inline"><p><img src="/iot-workshop/assets/img/function-vscode-01.422e06ad.png" alt="" width="200"> <img src="/iot-workshop/assets/img/function-vscode-02.01cbd64f.png" alt="" width="200"> <img src="/iot-workshop/assets/img/function-vscode-03.cc6807ef.png" alt="" width="200"> <img src="/iot-workshop/assets/img/function-vscode-04.57192b07.png" alt="" width="200"> <img src="/iot-workshop/assets/img/function-vscode-05.c322458e.png" alt="" width="200"></p></div> <p>Une fois ces options choisies, VS Code va automatiquement vous cr√©er un squelette de projet et de fonction. Il ex√©cutera
ensuite des t√¢ches n√©cessaires en fonction du langage: cr√©er un environnement virtuel en python, faire un package restore
en NodeJS ou en .Net, etc...</p> <p><img src="/iot-workshop/assets/img/function-vscode-08.c41eff11.png" alt=""></p> <p>Sachez que le projet que vous venez de cr√©er peut contenir d'autres functions, quelque soit leur trigger mais avec
le m√™me langage de programmation. Si vous souhaitez ajouter une nouvelle fonction, vous pouvez le faire
via la commande <code>Azure Functions: Create Function...</code></p> <h3 id="tester-et-debugguer-votre-projet"><a href="#tester-et-debugguer-votre-projet" class="header-anchor">#</a> Tester et d√©bugguer votre projet</h3> <p>Avant d'aller plus loin, nous allons tester que vous pouvez ex√©cuter et d√©bugger votre projet.
Si votre environnement de d√©veloppement est correctement install√©, vous devriez pouvoir lancer la commande
<code>Debug: Start debugging</code> (<em>F5</em>) et l'h√¥te Azure Functions va alors se lancer. Vous verrez appara√Ætre dans le terminal
l'adresse HTTP locale √† laquelle vous pouvez tester votre API.</p> <p><img src="/iot-workshop/assets/img/function-vscode-09.ecb7c21c.png" alt=""></p> <h2 id="creer-une-azure-function-‚ö°-dans-le-portail-azure-üë©‚Äçüíª"><a href="#creer-une-azure-function-‚ö°-dans-le-portail-azure-üë©‚Äçüíª" class="header-anchor">#</a> Cr√©er une Azure Function ‚ö° dans le portail Azure üë©‚Äçüíª</h2> <p>D√©velopper dans le portail n'est pas l'option recommand√©e pour un projet de production.
Vous pouvez √©galement <a href="#creer-une-fonction-dans-vs-code">d√©velopper votre fonction dans Visual Studio Code</a>.</p> <h3 id="creer-l-application"><a href="#creer-l-application" class="header-anchor">#</a> Cr√©er l'application</h3> <p>Avant de cr√©er une fonction, vous devez tout d'abord cr√©er un application. Depuis le
<a href="https://portal.azure.com?WT.mc_id=msroadshowwinter-event-yolasors" target="_blank" rel="noopener noreferrer">portail Azure<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>
, cliquez sur le bouton (+) en haut √† gauche, recherchez &quot;function&quot; et choisissez &quot;Function App&quot;. Vous pouvez √©galement
utiliser le
<a href="https://portal.azure.com/?feature.customportal=false&amp;WT.mc_id=msroadshowwinter-event-yolasors#create/Microsoft.FunctionApp" target="_blank" rel="noopener noreferrer">lien direct<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p> <p><img src="/iot-workshop/assets/img/function-create-09.86ecec6b.png" alt=""></p> <p>Une fois sur l'assistant de cr√©ation, vous aurez un certain nombre de questions auxquelles r√©pondre:</p> <ul><li><strong>Un nom d'application</strong>: ce nom servira √©galement √† g√©n√©rer une adresse en <code>mafonction.azurewebsites.net</code>. Il doit donc
√™tre unique sur l'ensemble des utilisateurs d'Azure,</li> <li><strong>Un abonnement</strong>: normalement, vous ne devriez avoir qu'un seul choix. Dans un contexte d'entreprise, il n'est pas rare
d'avoir plusieurs abonnements - pour s√©parer les environnements par exemple,</li> <li><strong>Un resource group</strong>: chaque ressource dans Azure doit √™tre plac√©e dans un conteneur logique. C'est le resource group,</li> <li><strong>Un Syst√®me d'exploitation</strong>: Windows ou Linux. Cela influencera la liste des langages support√©,</li> <li><strong>Un plan</strong>: C'est le mode de d√©ploiement de la fonction. S√©lectionnez <em>Consommation/comsumption</em>, ce qui vous permet
d'avoir une facturation √† l'usage, ainsi qu'un auto-scaling,</li> <li><strong>La stack</strong>: Node.Js, Java, .NET Core, Python. Faites votre choix !</li> <li><strong>Un emplacement</strong>: Cela correspond √† la zone dans laquelle votre fonction sera d√©ploy√©e. On vous recommende <em>France
Central</em> ou <em>Europe de l'Ouest</em>,</li> <li><strong>Un stockage</strong>: laissez l'assistant en cr√©er un. Il sert notamment √† aggr√©ger les logs et synchroniser les diff√©rentes
instances qui h√©bergeront votre fonction.</li></ul> <p>Il vous suffit alors de cliquer sur le bouton <strong>Create</strong> pour lancer la cr√©ation de l'application. Vous pouvez suivre
l'√©volution en cliquant sur l'ic√¥ne en forme de cloche en haut √† droite.</p> <div class="custom-block tip"><p class="custom-block-title">Note</p> <p>Un nouvel √©cran de cr√©ation d'une Function App est en cours de d√©ploiement. Bien que le design ait chang√©,
les questions
pos√©es sont identiques.</p></div> <p><img src="/iot-workshop/assets/img/function-create-10.01777615.png" alt=""></p> <p>Une fois l'application de function cr√©√©e, vous serez alors en mesure de cr√©er votre premi√®re fonction. Dans l'assistant
qui s'affiche, s√©lectionnez le mode d'√©dition <strong>In-portal</strong>. On vous proposera alors un type de mod√®le, choisissez
<em>Webhook + API</em>.</p> <div class="img-inline"><p><img src="/iot-workshop/assets/img/function-create-01.ef0edcec.png" alt="" width="350"> <img src="/iot-workshop/assets/img/function-create-02.1fa705d2.png" alt="" width="350"></p></div> <h3 id="coder-et-tester-dans-le-navigateur"><a href="#coder-et-tester-dans-le-navigateur" class="header-anchor">#</a> Coder et tester dans le navigateur</h3> <p>Vous aurez alors acc√®s √† un √©diteur de code. Le bouton &quot;Save&quot; vous permet d'enregistrer vos modifications sur le serveur
et de les d√©ployer directement. Le bouton &quot;Run&quot; vous permet d'ex√©cuter votre fonction, tout en voyant les logs en bas
de la page et la requ√™te √† ex√©cuter √† droite.</p> <div class="custom-block warning"><p class="custom-block-title">Attention</p> <p>Les raccourcis claviers, comme <em>Ctrl+S</em> ne fonctionnent pas dans le navigateur. Oui c'est assez frustrant üòÉ.</p></div> <p><img src="/iot-workshop/assets/img/function-create-03.d325bfec.png" alt=""></p> <p>Vous pouvez maintenant passer √† l'√©tape de coder la fonction de pr√©diction d'activit√© du compresseur.</p> <h2 id="ecrire-du-code-pour-detecter-l-activite-du-compresseur"><a href="#ecrire-du-code-pour-detecter-l-activite-du-compresseur" class="header-anchor">#</a> Ecrire du code pour d√©tecter l'activit√© du compresseur</h2> <p>Nous voulons maintenant √©crire un &quot;algorithme&quot; qui permettra de d√©tecter d'apr√®s les donn√©es de t√©l√©m√©trie si
le compresseur est en fonctionnement ou pas. Nous vous laissons le soin de concocter l'algorithme !
Il sera expos√© sous la forme d'une API REST, et sera appel√©e automatiquement par le <em>dispatcher</em> que
nous avons cr√©√©s.</p> <h3 id="input-output"><a href="#input-output" class="header-anchor">#</a> Input / Output</h3> <p>Votre API REST sera appel√©e par le dispatcher via une requ√™te POST, avec le body suivant:</p> <div class="language-json extra-class"><pre class="language-json"><code><span class="token punctuation">{</span>
    <span class="token string">&quot;deviceId&quot;</span> = <span class="token string">&quot;device-42&quot;</span><span class="token punctuation">,</span>
    <span class="token string">&quot;temperature&quot;</span> = <span class="token number">27.13</span><span class="token punctuation">,</span>
    <span class="token string">&quot;humidity&quot;</span> = <span class="token number">50.2</span><span class="token punctuation">,</span>
    <span class="token string">&quot;pressure&quot;</span> = <span class="token number">1004.8</span>
<span class="token punctuation">}</span>
</code></pre></div><p>Votre API doit retourner un JSON indiquant l'√©tat du compresseur, ainsi que la couleur de la LED √† afficher. L'id√©e est
d'avoir une LED verte quand le compresseur est √©teint (aucun risque), puis rouge quand il est en fonctionnement
(<em>attention, compresseur sous tension</em>).</p> <p>Le format de sortie attendu est le suivant:</p> <div class="language-json extra-class"><pre class="language-json"><code><span class="token punctuation">{</span>
    <span class="token property">&quot;state&quot;</span><span class="token operator">:</span> <span class="token string">&quot;running&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;led&quot;</span><span class="token operator">:</span> 
    <span class="token punctuation">{</span>
        <span class="token property">&quot;r&quot;</span><span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
        <span class="token property">&quot;g&quot;</span><span class="token operator">:</span> <span class="token number">255</span><span class="token punctuation">,</span>
        <span class="token property">&quot;b&quot;</span><span class="token operator">:</span> <span class="token number">0</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>La propri√©t√© <code>state</code> peut avoir comme valeurs <code>running</code> ou <code>idle</code>. Les valeurs de la led doivent √™tre entre 0 et 255.</p> <h3 id="quelques-exemples-d-api"><a href="#quelques-exemples-d-api" class="header-anchor">#</a> Quelques exemples d'API</h3> <p>Si vous voulez tester une API d√©j√† r√©alis√©e, voici quelques endpoints.</p> <div class="language- extra-class"><pre class="language-text"><code>https://iotcompressor-evaluation.azurewebsites.net/api/AlwaysGreen
https://iotcompressor-evaluation.azurewebsites.net/api/AlwaysGreen
https://iotcompressor-evaluation.azurewebsites.net/api/AlwaysRed
https://iotcompressor-evaluation.azurewebsites.net/api/Prediction?code=7j3bnVqlu2/KDArv8uTXadNfLqcNaTQEsIWeDTMvsD/8NL2sNQJoag==
</code></pre></div><h3 id="quelques-exemples-de-code"><a href="#quelques-exemples-de-code" class="header-anchor">#</a> Quelques exemples de code</h3> <h4 id="javascript"><a href="#javascript" class="header-anchor">#</a> JavaScript</h4> <p>Cet exemple de JavaScript va simplement retourner que le compresseur est tout le temps
en fonctionnement, et affiche une couleur de led rouge si la temp√©rature d√©passe les 30¬∞.</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code>module<span class="token punctuation">.</span><span class="token function-variable function">exports</span> <span class="token operator">=</span> <span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">context<span class="token punctuation">,</span> req</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    context<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'JavaScript HTTP trigger function processed a request.'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token keyword">var</span> temperatureRed <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>req<span class="token punctuation">.</span>body <span class="token operator">&amp;&amp;</span> req<span class="token punctuation">.</span>body<span class="token punctuation">.</span>temperature <span class="token operator">&gt;</span> <span class="token number">30</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        temperatureRed <span class="token operator">=</span> <span class="token number">255</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    context<span class="token punctuation">.</span>res <span class="token operator">=</span> <span class="token punctuation">{</span>
            body<span class="token operator">:</span> <span class="token punctuation">{</span>
                <span class="token string">&quot;state&quot;</span><span class="token operator">:</span> <span class="token string">&quot;running&quot;</span><span class="token punctuation">,</span>
                <span class="token string">&quot;led&quot;</span><span class="token operator">:</span> 
                <span class="token punctuation">{</span>
                    <span class="token string">&quot;r&quot;</span><span class="token operator">:</span> temperatureRed<span class="token punctuation">,</span>
                    <span class="token string">&quot;g&quot;</span><span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
                    <span class="token string">&quot;b&quot;</span><span class="token operator">:</span> <span class="token number">0</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><h2 id="deployez-votre-fonction-dans-azure-‚òÅÔ∏è"><a href="#deployez-votre-fonction-dans-azure-‚òÅÔ∏è" class="header-anchor">#</a> D√©ployez votre fonction dans Azure ‚òÅÔ∏è</h2> <p>Votre fonction est d√©sormais pr√™te pour le prime time ? Allons la d√©ployer sur Azure !</p> <blockquote><p>Comme indiqu√© pr√©c√©demment, nous allons ici la d√©ployer sur Azure, mais nous pourrions la d√©ployer
sur d'autres environnements.</p></blockquote> <h3 id="vous-l-avez-developpe-dans-le-portail-azure"><a href="#vous-l-avez-developpe-dans-le-portail-azure" class="header-anchor">#</a> Vous l'avez d√©velopp√© dans le portail Azure</h3> <p>Si vous avez √©crit votre fonction depuis le portail Azure, alors elle est automatiquement d√©ploy√©e √† chaque fois que
vous appuyez sur le bouton &quot;Save&quot;. Vous n'avez donc rien √† faire !</p> <h3 id="deployer-depuis-visual-studio-code"><a href="#deployer-depuis-visual-studio-code" class="header-anchor">#</a> D√©ployer depuis Visual Studio Code</h3> <p>Si vous avez cr√©√© votre projet depuis Visual Studio Code, vous allez pouvoir de d√©ployer directement depuis l'√©diteur.
Pour cela, deux options :</p> <ul><li>Dans le menu contextuel sur l'arborescence, avec l'option <strong>Deploy to Function app</strong>,</li> <li>Depuis la barre de commandes avec la commande <strong>Azure Functions: Deploy to Function app</strong>.</li></ul> <p>Quel que ce choix de d√©part, la suite des √©tapes est identique.</p> <p><img src="/iot-workshop/assets/img/function-deploy-01.bac3abee.png" alt=""> <img src="/iot-workshop/assets/img/function-deploy-02.d6f674dd.png" alt=""></p> <div class="custom-block warning"><p class="custom-block-title">Attention</p> <p>Si vous n'avez jamais utilis√© Azure avec Visual Studio Code, il faudra connecter votre compte Azure √† VS Code.
Un navigateur web devrait alors d'ouvrir vous demandant de vous connecter √† votre compte Azure.</p></div> <p>L'assistanv de VS code va alors vous poser un certain nombre de quesitons :</p> <ul><li><strong>Dans quel abonnement d√©ployer l'application</strong>: normalement, vous ne devriez avoir qu'un seul choix. Dans un contexte
d'entreprise, il n'est pas rare d'avoir plusieurs abonnements - pour s√©parer les environnements par exemple,</li> <li><strong>Dans quelle Function app?</strong>: nous allons ici en cr√©er une nouvelle,</li> <li><strong>Un nom d'application</strong>: ce nom servira √©galement √† g√©n√©rer une adresse en <code>mafonction.azurewebsites.net</code>. Il doit donc
√™tre unique sur l'ensemble des utilisateurs d'Azure,</li> <li><strong>Un emplacement</strong>: Cela correspond √† la zone dans laquelle votre fonction sera d√©ploy√©e. On vous recommende <em>France
Central</em> ou <em>Europe de l'Ouest</em>,</li></ul> <p><img src="/iot-workshop/assets/img/function-deploy-03.faf55eaf.png" alt=""> <img src="/iot-workshop/assets/img/function-deploy-04.ed96de2a.png" alt=""> <img src="/iot-workshop/assets/img/function-deploy-05.cec81f19.png" alt=""> <img src="/iot-workshop/assets/img/function-deploy-06.2c96e786.png" alt=""></p> <p>VS Code va alors d√©ployer l'ensemble des ressources n√©cessaires √† l'h√©bergement de votre application, puis d√©ployer
votre code dans cette application. Cela peut prendre quelques minutes.</p> <p><img src="/iot-workshop/assets/img/function-deploy-07.9be335bc.png" alt=""></p> <div class="custom-block tip"><p class="custom-block-title">Note</p> <p>Si vous avez effectu√© une modification de code et que vous souhaitez d√©ployer une mise √† jour, il suffit de suivre
les m√™mes √©tapes, mais en s√©lectionnant l'applicaiton Azure Function d√©j√† cr√©√©e dans la liste.</p></div> <h3 id="deployer-depuis-la-ligne-de-commande-ou-la-cd-ci"><a href="#deployer-depuis-la-ligne-de-commande-ou-la-cd-ci" class="header-anchor">#</a> D√©ployer depuis la ligne de commande ou la CD/CI</h3> <p><img src="/iot-workshop/assets/img/notpublish-friends-sticker.a0d3288f.png" alt=""></p> <p>En environnement de production, il est rare de d√©ployer ces ressources via un clic-droit. Il est possible de d√©ployer
des Azure Functions depuis une ligne de commande ou bien depuis un pipeline de CD/CI.</p> <h3 id="recuperer-l-url-de-la-fonction"><a href="#recuperer-l-url-de-la-fonction" class="header-anchor">#</a> R√©cup√©rer l'URL de la fonction</h3> <p>Via la barre &quot;Azure&quot; (celle avec un logo A dans la barre lat√©rale gauche), il est possible d'explorer l'ensemble des
Azure Functions de ses souscriptions. Un clic droit sur la fonction permet alors de r√©cup√©rer l'URL √† appeler.</p> <p><img src="/iot-workshop/assets/img/function-deploy-14.c1e6996c.png" alt=""></p> <p>Si vous avez choisi un mode d'autentification <code>Function</code>, cette URL contiendra alors directement la cl√© d'API.</p> <h3 id="streamer-les-logs-depuis-azure"><a href="#streamer-les-logs-depuis-azure" class="header-anchor">#</a> Streamer les logs depuis Azure</h3> <p>Une fois votre fonction d√©ploy√©e, il est possible de streamer ces logs directement depuis Visual Studio Code.
Pour cela, il suffit de cliquer sur le bouton dans la notification ou d'utiliser la commande
<strong>Azure Functions: Start Streaming Logs</strong>.</p> <p><img src="/iot-workshop/assets/img/function-deploy-12.0f41e4cc.png" alt=""></p> <h2 id="connectez-votre-function-a-tailwind-diving-üè≠"><a href="#connectez-votre-function-a-tailwind-diving-üè≠" class="header-anchor">#</a> Connectez votre function √† Tailwind Diving üè≠</h2> <p>Maintenant que votre Azure Function de pr√©diction est pr√™te, il est temps de la connecter au service !
Comme indiqu√© pr√©c√©demment, nous avons d√©j√† connect√© votre board √† Azure. Il faut donc maintenant
que notre syst√®me connaisse votre board afin de pouvoir appeler votre fonction √† la r√©ception
d'une nouvelle donn√©e de t√©l√©m√©trie.</p> <h3 id="recuperer-l-adresse-de-son-azure-function"><a href="#recuperer-l-adresse-de-son-azure-function" class="header-anchor">#</a> R√©cup√©rer l'adresse de son Azure Function</h3> <p>L'adresse de votre Azure Function est compos√©e de diff√©rentes parties :</p> <ul><li>Le nom de votre application (choisi au moment de la cr√©ation), suivi de <code>azurewebsites.net</code>,</li> <li>un pr√©fixe, souvent <code>api</code>,</li> <li>le nom de votre m√©thode,</li> <li>si votre fonction est prot√©g√©e, la cl√© de fonction (propre √† chaque fonction), ou une des <em>master keys</em> permettant
d'acc√©der √† l'ensemble des fonctions de l'application.</li></ul> <p>Le plus simple pour r√©cup√©rer l'adresse est de se rendre dans le portail Azure sur votre application. Choisissez ensuite
votre fonction et cliquez sur le lien **Get Function **.</p> <p><img src="/iot-workshop/assets/img/function-connect-01.57fdc14c.png" alt=""></p> <p>La popup qui s'ouvre alors contient le chemin vers votre fonction, et √©ventuellement avec la cl√©e de fonction. Copiez
cette URL pour la prochaine √©tape.</p> <p><img src="/iot-workshop/assets/img/function-connect-02.a7cddfa1.png" alt=""></p> <blockquote><p>Bien √©videmment, il est possible de d√©ployer une Azure Function avec son propre nom de domaine, mais √©galement
avec ses propres pr√©fixes ou chemins. La preuve ? <a href="https://www.maneu.fr/?wt.mc_id=blinkingcompressor-github-chmaneu" target="_blank" rel="noopener noreferrer">maneu.fr<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>
n'est qu'une Azure Function :smiling:.</p></blockquote> <h3 id="enregistrer-son-webhook"><a href="#enregistrer-son-webhook" class="header-anchor">#</a> Enregistrer son webhook</h3> <p>Nous avons d√©velopp√©s un <a href="https://backend-registrationwebsite.azurewebsites.net/" target="_blank" rel="noopener noreferrer">petit site<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> qui vous permet d'enregistrer votre webhook. Il suffit
de s√©lectionner votre device dans la combo (son n¬∞ est inscrit au dos de la board), et de coller l'URL de votre
Azure Function. Si vous souhaitez que votre webhook soit appel√© pour test, il vous suffit de cliquer sur
&quot;Test Callback Url&quot;.</p> <p><img src="/iot-workshop/assets/img/connector.0c62b5fd.png" alt=""> <a href="https://backend-registrationwebsite.azurewebsites.net/" target="_blank" rel="noopener noreferrer">https://backend-registrationwebsite.azurewebsites.net/<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p> <h3 id="tester-son-fonctionnement"><a href="#tester-son-fonctionnement" class="header-anchor">#</a> Tester son fonctionnement</h3> <p>D√©sormais, votre Azure Function devrait √™tre appel√©e √† chaque r√©ception de donn√©e t√©l√©m√©trique du device. En situation normale
(version de code 0.2), cela arrivera environ toutes les 10 secondes. Vous pouvez streamer les logs (depuis VS Code ou
le portail) pour voir l'ex√©cution de votre fonction.</p> <p>Pour changer les valeurs de votre board, il suffit g√©n√©ralement d'appliquer l'un de vos doigts sur le capteur de temp√©rature.
Si cela ne suffit pas, vous pouvez frotter votre doigt contre la paume de la main pour le r√©chauffer.
Penez √† laisser votre doigt plusieurs secondes, les donn√©es n'√©tant pas envoy√©es √† chaque seconde.</p> <h3 id="c-est-reussi"><a href="#c-est-reussi" class="header-anchor">#</a> C'est r√©ussi ?</h3> <p>Si votre board change bien de couleur selon votre algorithme, c'est gagn√© ! Passons au prochain module üöÄ.
Dans le cas contraire, faites appel √† l'un des assistants afin de comprendre pourquoi cela ne fonctionne pas.</p></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ‚Üê
      <a href="/iot-workshop/01-prepare-environment.html" class="prev">1. Pr√©paration</a></span> <span class="next"><a href="/iot-workshop/03-connect-iot-devices-hub.html">3. Connection au cloud</a>
      ‚Üí
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/iot-workshop/assets/js/app.8c4c5b71.js" defer></script><script src="/iot-workshop/assets/js/2.7913e008.js" defer></script><script src="/iot-workshop/assets/js/3.091fb9b7.js" defer></script>
  </body>
</html>
